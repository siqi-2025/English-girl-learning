# English Learning Assistant - 架构设计文档

**文档版本**: v1.0 (James版本号系统)  
**创建日期**: 2024-08-28  
**最后更新**: 2024-08-28

## 系统架构概览

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   图片输入模块   │───▶│   OCR识别模块   │───▶│  内容处理模块   │
│   Image Input   │    │  Python/OCR    │    │   AI Analysis   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                      │
                                                      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   习题生成器    │◀───│   文档生成器    │◀───│   内容分类器    │
│ Exercise Gen    │    │   Markdown     │    │ Content Class   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 核心模块设计

### 1. OCR识别模块 (Python)
- **职责**: 图片文字识别
- **输入**: 图片文件 (JPG/PNG)
- **输出**: 结构化文本数据
- **技术栈**: Python + OpenCV + OCR库

### 2. AI内容处理模块 (智普AI)
- **职责**: 文本分析、分类、习题生成
- **模型**: GLM-4.5-flash
- **功能**:
  - 课文内容分析和单元划分
  - 词汇提取和难度分级
  - 多种题型自动生成

### 3. 文档生成模块
- **职责**: 格式化输出
- **输出格式**: Markdown
- **分类**: 课文文档、词汇文档、习题文档

## 数据流设计

### 数据流程图
```
图片文件 → OCR解析 → 原始文本 → AI分析 → 结构化数据 → 文档生成
   │           │         │        │          │           │
   │           │         │        │          │           ▼
   │           │         │        │          │       课文.md
   │           │         │        │          │       词汇.md  
   │           │         │        │          │       习题.md
   │           │         │        │          │
   ▼           ▼         ▼        ▼          ▼
Input/      Text/     Raw/     Processed/  Output/
images/    raw.txt   content/  data.json  docs/
```

### 数据结构设计

#### OCR输出格式
```json
{
  "filename": "unit1_page1.jpg",
  "text": "Unit 1: My name's Gina...",
  "confidence": 0.95,
  "timestamp": "2024-01-01T10:00:00Z"
}
```

#### AI分析输出格式
```json
{
  "unit": 1,
  "title": "My name's Gina",
  "content": {
    "dialog": "...",
    "grammar": "...",
    "vocabulary": [
      {
        "word": "name",
        "meaning": "名字",
        "level": "primary",
        "example": "My name is Tom."
      }
    ]
  }
}
```

## AI集成设计

### 智普AI集成架构
```python
class ZhipuAIService:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"
        self.model = "glm-4.5-flash"
    
    def analyze_content(self, text: str) -> dict:
        # 内容分析和分类
        pass
    
    def generate_exercises(self, content: dict) -> dict:
        # 习题生成
        pass
```

### AI Prompt设计

#### 内容分析Prompt
```
请分析以下英语教材内容，按以下格式输出：
1. 识别单元编号和标题
2. 提取对话内容
3. 识别语法点
4. 提取词汇（区分小学/中学难度）
5. 输出JSON格式数据

文本内容：{ocr_text}
```

#### 习题生成Prompt
```
根据以下课文内容生成英语练习题：
1. 中英互译题（5题）
2. 字母填空题（5题）
3. 短语填空题（3题）
4. 课文默写题（按段落）

课文内容：{lesson_content}
词汇列表：{vocabulary_list}
```

## 模块间通信

### 接口设计
```python
# OCR模块接口
class OCRService:
    def recognize_image(self, image_path: str) -> str
    def batch_recognize(self, image_dir: str) -> List[dict]

# AI服务接口  
class AIService:
    def classify_content(self, text: str) -> dict
    def extract_vocabulary(self, text: str) -> List[dict]
    def generate_exercises(self, content: dict) -> dict

# 文档生成接口
class DocumentGenerator:
    def generate_lesson_docs(self, lessons: List[dict]) -> None
    def generate_vocab_docs(self, vocabulary: List[dict]) -> None  
    def generate_exercise_docs(self, exercises: dict) -> None
```

## 错误处理与容错

### 异常处理策略
1. **OCR识别失败**: 记录失败文件，提供手动重试机制
2. **AI API限流**: 实现指数退避重试策略
3. **内容分类错误**: 提供人工校验接口
4. **文件生成失败**: 自动备份和恢复机制

### 质量控制
```python
class QualityController:
    def validate_ocr_result(self, result: dict) -> bool:
        return result['confidence'] > 0.8
    
    def validate_ai_classification(self, result: dict) -> bool:
        required_fields = ['unit', 'title', 'content']
        return all(field in result for field in required_fields)
```

## 性能优化设计

### 批处理优化
- OCR批量处理提高效率
- AI请求合并减少API调用
- 异步处理提高并发性能

### 缓存策略
- OCR结果缓存避免重复识别
- AI分析结果缓存节省费用
- 文档增量更新减少重复生成

## 配置管理

### 配置文件结构
```yaml
# config.yaml
ocr:
  confidence_threshold: 0.8
  language: 'chi_sim+eng'
  
ai:
  api_key: "${ZHIPU_API_KEY}"
  model: "glm-4.5-flash"
  temperature: 0.7
  max_tokens: 2000
  
output:
  format: "markdown"
  encoding: "utf-8"
  base_path: "./output"
```

## 安全性设计

### API密钥管理
- 环境变量存储API密钥
- 配置文件不包含敏感信息
- 运行时密钥加密存储

### 数据安全
- 本地处理敏感教育内容
- API传输数据最小化
- 生成文档访问权限控制