# English Learning Assistant - 技术栈选型文档
**文档版本**: v1.1 (James版本号系统)  
**创建日期**: 2024-08-28  
**最后更新**: 2024-08-28

## 🔄 更新记录
- **v1.1** (2024-08-28): 
  - 更新虚拟环境命名为项目特定名称
  - 升级OCR技术方案为AI增强型OCR (PaddleOCR 3.1 + 智普AI)
  - 更新配置管理相关命名规范

## 技术栈总览

| 功能模块 | 技术选型 | 版本要求 | 选择理由 |
|---------|---------|----------|----------|
| OCR识别 | AI增强型OCR (PaddleOCR 3.1 + 智普AI) | Python 3.8+ | AI增强识别，准确率提升30%+ |
| AI处理 | 智普AI GLM-4.5-flash | API v4 | 中文理解能力强，成本低 |
| 文档生成 | Python-markdown | 3.4+ | 轻量级，格式化灵活 |
| 图像处理 | OpenCV | 4.5+ | 图像预处理，提高OCR准确率 |
| 并发处理 | asyncio + aiohttp | Python标准库 | 异步处理，提高API调用效率 |
| 配置管理 | PyYAML | 6.0+ | 配置文件管理 |
| 日志记录 | loguru | 0.7+ | 结构化日志，便于调试 |

## 核心技术选型详解

### 1. AI增强型OCR技术选型

#### 选择：PaddleOCR 3.1 + 智普AI双重增强
```python
# 本地环境安装命令（云端使用备用方案）
pip install paddlepaddle paddleocr  # 本地开发环境
# 注意：云端部署使用AI增强文本分析备用方案
```

**2024年AI增强技术方案**:
- 🤖 **PaddleOCR 3.1**: 基础文字识别 + PP-ChatOCRv4 AI理解
- 🧠 **智普AI GLM-4.5-flash**: 后处理优化和语义校正
- 🔄 **双重验证**: OCR识别 + AI语义分析确保准确性

**核心优势**:
- ✅ **AI增强识别**: 集成ERNIE 4.5多模态大模型，准确率提升30%+
- ✅ **智能语义理解**: 自动纠正OCR错误，理解上下文语义
- ✅ **多语言支持**: 37种语言识别，中英文混合文档优化
- ✅ **复杂文档解析**: PP-StructureV3智能解析文档结构
- ✅ **轻量级部署**: 17MB模型大小，支持边缘计算

**vs 传统OCR方案对比**:
- vs 单纯PaddleOCR: AI理解能力，语义校正准确率提升30%+
- vs Tesseract: 中英文混合识别准确率高出50%+
- vs 云端OCR: 本地AI增强 + 云端语义校正，兼具安全性和准确性

#### AI增强OCR使用示例
```python
from paddleocr import PaddleOCR
import requests
import json

class AIEnhancedOCR:
    def __init__(self, zhipu_api_key: str):
        # 初始化PaddleOCR 3.1 (包含AI增强功能)
        self.ocr = PaddleOCR(
            use_angle_cls=True, 
            lang='ch',  # 支持37种语言
            show_log=False,
            use_gpu=False,  # 云端使用CPU版本
            enable_mkldnn=True  # 性能优化
        )
        
        # 智普AI后处理客户端
        self.ai_client = ZhipuAIClient(zhipu_api_key)
    
    def enhanced_ocr(self, image_path: str) -> dict:
        """AI增强OCR识别"""
        # 第一步：PaddleOCR基础识别
        ocr_results = self.ocr.ocr(image_path, cls=True)
        raw_text = self._extract_text(ocr_results)
        
        # 第二步：智普AI语义校正和理解
        enhanced_result = self.ai_client.enhance_ocr_result(
            raw_text=raw_text,
            context="英语教材内容识别"
        )
        
        return {
            'raw_ocr': raw_text,
            'ai_enhanced': enhanced_result['corrected_text'],
            'confidence': enhanced_result['confidence'],
            'corrections': enhanced_result['corrections']
        }
    
    def _extract_text(self, ocr_results) -> str:
        """提取OCR识别文字"""
        text_lines = []
        if ocr_results and ocr_results[0]:
            for line in ocr_results[0]:
                text_lines.append(line[1][0])
        return '\n'.join(text_lines)

# 使用示例
api_key = os.getenv("ENGLISH_LEARNING_ZHIPU_API_KEY")  # 从环境变量获取
ai_ocr = AIEnhancedOCR(api_key)
result = ai_ocr.enhanced_ocr('english_textbook.jpg')
print("AI增强识别结果:", result['ai_enhanced'])
```

### 2. AI服务选型

#### 选择：智普AI GLM-4.5-flash
- **模型**: `glm-4.5-flash`
- **API文档**: https://docs.bigmodel.cn/cn/guide/start/quick-start
- **密钥配置**: 通过环境变量 `ENGLISH_LEARNING_ZHIPU_API_KEY` 设置

**优势**:
- ✅ 中文理解和生成能力强
- ✅ Flash版本响应速度快
- ✅ 成本相对较低
- ✅ 支持长文本处理
- ✅ 教育场景优化良好

#### API集成示例
```python
import requests
import json

class ZhipuAIClient:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {api_key}"
        }
    
    def chat(self, messages: list, temperature: float = 0.7):
        payload = {
            "model": "glm-4.5-flash",
            "messages": messages,
            "temperature": temperature,
            "top_p": 0.8,
            "max_tokens": 2000
        }
        
        response = requests.post(
            self.base_url, 
            headers=self.headers, 
            json=payload
        )
        return response.json()
```

### 3. Python依赖包管理

#### 云端兼容依赖
```txt
# requirements.txt - 云端版本（无PaddleOCR依赖）
streamlit>=1.28.0
requests>=2.25.0
pyyaml>=6.0
markdown>=3.3.0
pillow>=8.0.0
numpy>=1.21.0,<2.0.0
opencv-python-headless>=4.5.0
scikit-image>=0.19.0
numpy>=1.24.0
```

#### 开发环境依赖
```txt
# requirements-dev.txt
pytest>=7.4.0
black>=23.7.0
flake8>=6.0.0
mypy>=1.5.0
```

### 4. 图像预处理技术

#### OpenCV图像优化
```python
import cv2
import numpy as np

class ImagePreprocessor:
    @staticmethod
    def enhance_image(image_path: str) -> np.ndarray:
        # 读取图像
        img = cv2.imread(image_path)
        
        # 转换为灰度图
        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
        
        # 降噪处理
        denoised = cv2.medianBlur(gray, 3)
        
        # 锐化处理
        kernel = np.array([[-1,-1,-1], [-1,9,-1], [-1,-1,-1]])
        sharpened = cv2.filter2D(denoised, -1, kernel)
        
        # 二值化处理
        _, binary = cv2.threshold(sharpened, 0, 255, 
                                 cv2.THRESH_BINARY + cv2.THRESH_OTSU)
        
        return binary
```

### 5. 异步处理架构

#### AsyncIO + aiohttp
```python
import asyncio
import aiohttp
from typing import List

class AsyncAIProcessor:
    def __init__(self, api_key: str, max_concurrent: int = 5):
        self.api_key = api_key
        self.semaphore = asyncio.Semaphore(max_concurrent)
    
    async def process_texts(self, texts: List[str]) -> List[dict]:
        async with aiohttp.ClientSession() as session:
            tasks = [
                self.process_single_text(session, text) 
                for text in texts
            ]
            return await asyncio.gather(*tasks)
    
    async def process_single_text(self, session, text: str) -> dict:
        async with self.semaphore:
            # API调用逻辑
            pass
```

### 6. 配置管理方案

#### YAML配置文件
```yaml
# config/config.yaml
app:
  name: "English Learning Assistant"
  version: "1.0.0"
  debug: false

ocr:
  engine: "paddleocr"
  languages: ["ch", "en"]
  confidence_threshold: 0.8
  use_gpu: false
  angle_classification: true

ai:
  provider: "zhipu"
  model: "glm-4.5-flash"
  api_key_env: "ZHIPU_API_KEY"  # 环境变量名
  temperature: 0.7
  top_p: 0.8
  max_tokens: 2000
  retry_times: 3
  timeout: 30

paths:
  input_images: "D:/360MoveData/Users/wukon/Pictures/7上英语"
  output_base: "./output"
  cache_dir: "./cache"
  log_dir: "./logs"

processing:
  batch_size: 10
  max_workers: 5
  enable_cache: true
  
quality:
  ocr_confidence_min: 0.8
  manual_review_threshold: 0.9
```

#### 配置加载类
```python
import yaml
import os
from typing import Dict, Any

class Config:
    def __init__(self, config_path: str = "config/config.yaml"):
        with open(config_path, 'r', encoding='utf-8') as f:
            self._config = yaml.safe_load(f)
        
        # 加载环境变量
        self._load_env_vars()
    
    def _load_env_vars(self):
        """从环境变量加载敏感配置"""
        api_key_env = self._config['ai']['api_key_env']
        api_key = os.getenv(api_key_env)
        if not api_key:
            raise ValueError(f"Environment variable {api_key_env} not found")
        self._config['ai']['api_key'] = api_key
    
    def get(self, key_path: str, default=None) -> Any:
        """获取嵌套配置值，如 'ai.model'"""
        keys = key_path.split('.')
        value = self._config
        for key in keys:
            value = value.get(key, {})
            if not isinstance(value, dict) and key != keys[-1]:
                return default
        return value if value != {} else default
```

### 7. 日志管理方案

#### Loguru日志配置
```python
from loguru import logger
import sys

def setup_logging(config: Config):
    # 移除默认handler
    logger.remove()
    
    # 控制台输出
    logger.add(
        sys.stdout,
        format="<green>{time:YYYY-MM-DD HH:mm:ss}</green> | <level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>",
        level="INFO" if not config.get('app.debug') else "DEBUG"
    )
    
    # 文件输出
    log_dir = config.get('paths.log_dir', './logs')
    logger.add(
        f"{log_dir}/app.log",
        rotation="1 day",
        retention="30 days",
        compression="zip",
        format="{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | {name}:{function}:{line} - {message}",
        level="DEBUG"
    )
    
    # 错误日志单独记录
    logger.add(
        f"{log_dir}/error.log",
        level="ERROR",
        rotation="1 week",
        retention="12 weeks"
    )
```

### 8. 项目结构设计

```
English-girl-learning/
├── config/                 # 配置文件
│   ├── config.yaml        # 主配置
│   └── prompts.yaml       # AI提示词配置
├── src/                   # 源代码
│   ├── __init__.py
│   ├── ocr/              # OCR模块
│   │   ├── __init__.py
│   │   ├── paddle_ocr.py
│   │   └── preprocessor.py
│   ├── ai/               # AI处理模块
│   │   ├── __init__.py
│   │   ├── zhipu_client.py
│   │   └── prompts.py
│   ├── document/         # 文档生成模块
│   │   ├── __init__.py
│   │   ├── markdown_gen.py
│   │   └── templates/
│   ├── utils/            # 工具模块
│   │   ├── __init__.py
│   │   ├── config.py
│   │   └── logging.py
│   └── main.py          # 主程序入口
├── tests/               # 测试用例
├── output/              # 输出目录
├── cache/               # 缓存目录
├── logs/                # 日志目录
├── requirements.txt     # 依赖列表
├── requirements-dev.txt # 开发依赖
├── setup.py            # 安装脚本
└── README.md           # 项目说明
```

## 部署和运行要求

### 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: 3.8+
- **内存**: 最小4GB，推荐8GB+
- **存储**: 可用空间2GB+（模型文件）

### 安装部署
```bash
# 1. 克隆项目
git clone https://github.com/user/English-girl-learning.git
cd English-girl-learning

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 设置环境变量
export ENGLISH_LEARNING_ZHIPU_API_KEY="your-api-key-here"

# 5. 运行程序
python src/main.py
```

## 性能预期

### 处理速度估算
- **OCR识别**: ~2-3秒/张图片
- **AI分析**: ~5-10秒/页内容
- **文档生成**: <1秒/文档
- **整体流程**: ~50-100张图片/小时

### 成本估算
- **计算成本**: 本地OCR无额外费用
- **AI调用**: 基于智普AI定价，预估每本教材<10元
- **存储成本**: 本地存储，基本无成本