# English Learning Assistant - 项目搭建指南
**文档版本**: v1.1 (James版本号系统)  
**创建日期**: 2024-08-28  
**最后更新**: 2024-08-28

## 🔄 更新记录
- **v1.1** (2024-08-28): 
  - 更新虚拟环境命名为项目特定名称 (english-learning-env)
  - 升级PaddleOCR版本到3.1.0支持AI增强
  - 更新配置管理相关环境变量命名

## 开发环境准备

### 系统要求
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **Python**: 3.8 - 3.11 (推荐 3.9)
- **内存**: 最少4GB，推荐8GB+
- **存储**: 可用空间3GB+ (包含模型文件)
- **网络**: 稳定的网络连接 (用于AI API调用)

### 开发工具准备
```bash
# 1. 安装Python (如果未安装)
# 访问 https://python.org 下载安装包

# 2. 安装Git (如果未安装)  
# 访问 https://git-scm.com 下载安装包

# 3. 验证安装
python --version  # 应显示 Python 3.8+
git --version     # 应显示 git version
```

## 项目初始化

### 1. 创建项目目录
```bash
# 创建项目根目录
mkdir English-girl-learning
cd English-girl-learning

# 创建完整的目录结构
mkdir -p src/{ui,core,utils}
mkdir -p config tests docs .streamlit
mkdir -p output cache logs temp
```

### 2. 创建项目特定虚拟环境
```bash
# 创建项目特定的虚拟环境 (避免与其他项目冲突)
python -m venv english-learning-env

# 激活虚拟环境
# Windows:
english-learning-env\Scripts\activate
# macOS/Linux:
source english-learning-env/bin/activate

# 验证虚拟环境 (确保使用项目专用环境)
which python  # 应指向 english-learning-env 中的python
echo $VIRTUAL_ENV  # 应显示 english-learning-env 路径
```

### 3. 安装依赖包
```bash
# 创建requirements.txt (云端兼容版本)
cat > requirements.txt << EOF
# Web框架
streamlit>=1.28.0

# 网络和API
requests>=2.25.0

# 配置和文档处理
pyyaml>=6.0
markdown>=3.3.0

# 图像处理 - 基础版本
pillow>=8.0.0
numpy>=1.21.0,<2.0.0
opencv-python-headless>=4.5.0

# AI分析核心功能
scikit-image>=0.19.0
markdown==3.5.1
python-docx==0.8.11

# 开发和测试
pytest==7.4.3
black==23.9.1
flake8==6.1.0
EOF

# 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 验证关键包安装
python -c "import streamlit; print('Streamlit:', streamlit.__version__)"
python -c "import paddleocr; print('PaddleOCR: OK')"
```

## 核心文件创建

### 1. 项目配置文件

#### config/app_config.yaml
```yaml
# 应用基础配置
app:
  name: "English Learning Assistant"
  version: "1.0.0"
  debug: true
  
# AI增强OCR配置
ocr:
  engine: "paddleocr"
  version: "3.1.0"  # AI增强版本
  languages: ["ch", "en"]  # 支持37种语言
  use_gpu: false
  confidence_threshold: 0.8
  angle_classification: true
  enable_mkldnn: true  # 性能优化
  ai_enhanced: true    # 启用AI增强功能
  
# AI配置
ai:
  provider: "zhipu"
  model: "glm-4.5-flash" 
  base_url: "https://open.bigmodel.cn/api/paas/v4/chat/completions"
  temperature: 0.7
  top_p: 0.8
  max_tokens: 2000
  timeout: 30
  retry_times: 3
  
# 处理配置
processing:
  batch_size: 5
  max_workers: 3
  max_file_size: 10  # MB
  supported_formats: ["jpg", "jpeg", "png", "bmp"]
  
# 路径配置
paths:
  input_default: "D:/360MoveData/Users/wukon/Pictures/7上英语"
  output_base: "./output"
  cache_dir: "./cache"
  temp_dir: "./temp"
  log_dir: "./logs"
```

#### config/prompts.yaml
```yaml
# AI提示词配置
prompts:
  content_analysis: |
    请分析以下英语教材内容，按JSON格式输出：
    {
      "unit": "单元编号",
      "title": "单元标题", 
      "content_type": "dialog/reading/grammar",
      "main_content": "主要内容",
      "vocabulary": [
        {
          "word": "单词",
          "meaning": "中文含义",
          "level": "primary/middle",
          "example": "例句"
        }
      ],
      "grammar_points": ["语法点1", "语法点2"]
    }
    
    文本内容：{text}
    
  exercise_generation: |
    根据以下课文内容和词汇列表，生成英语练习题：
    
    要求：
    1. 中英互译题5道
    2. 字母填空题5道  
    3. 短语填空题3道
    4. 课文默写题（按段落分割）
    
    输出格式为JSON：
    {
      "translation": [
        {"question": "题目", "answer": "答案", "type": "zh_to_en/en_to_zh"}
      ],
      "letter_filling": [
        {"question": "题目（用_表示空缺字母）", "answer": "完整单词"}
      ],
      "phrase_filling": [
        {"question": "句子（用___表示空缺短语）", "answer": "正确短语"}
      ],
      "dictation": [
        {"chinese": "中文段落", "english": "对应英文段落"}
      ]
    }
    
    课文内容：{content}
    词汇列表：{vocabulary}
    
  vocabulary_classification: |
    请将以下英语单词按照难度等级分类：
    - primary: 小学水平词汇
    - middle: 初中水平词汇
    
    对每个单词提供中文释义和例句。
    
    输出JSON格式：
    {
      "primary": [
        {"word": "单词", "meaning": "中文", "example": "例句"}
      ],
      "middle": [
        {"word": "单词", "meaning": "中文", "example": "例句"}
      ]
    }
    
    单词列表：{words}
```

### 2. Streamlit配置

#### .streamlit/config.toml
```toml
[server]
port = 8501
enableCORS = false
enableXsrfProtection = false
maxUploadSize = 50

[theme]
primaryColor = "#FF6B6B"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F0F2F6" 
textColor = "#262730"
font = "sans serif"

[browser]
gatherUsageStats = false
```

#### .streamlit/secrets.toml (本地开发用)
```toml
# API密钥配置 (项目特定命名)
[api]
ENGLISH_LEARNING_ZHIPU_API_KEY = "your-api-key-here"

# 项目特定设置
[english_learning_settings]
DEBUG = true
LOG_LEVEL = "DEBUG"
PROJECT_NAME = "English Learning Assistant"
ENVIRONMENT = "development"
```

### 3. 核心代码结构

#### streamlit_app.py (应用入口)
```python
"""
English Learning Assistant - 主应用入口
基于OCR和AI的英语教材处理工具
"""

import streamlit as st
import sys
import os
from pathlib import Path

# 添加src目录到Python路径
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root / "src"))

def main():
    """主应用函数"""
    # 页面配置
    st.set_page_config(
        page_title="English Learning Assistant",
        page_icon="📚",
        layout="wide",
        initial_sidebar_state="expanded",
        menu_items={
            'Get Help': 'https://github.com/yourusername/English-girl-learning',
            'Report a bug': 'https://github.com/yourusername/English-girl-learning/issues',
            'About': """
            # English Learning Assistant
            基于OCR识别和AI分析的英语学习辅助工具
            
            **功能特性:**
            - 🔍 OCR图片识别
            - 🤖 AI内容分析分类
            - 📝 自动生成Markdown文档
            - 📋 智能习题生成
            """
        }
    )
    
    # 初始化会话状态
    if 'session_id' not in st.session_state:
        import uuid
        st.session_state.session_id = str(uuid.uuid4())
    
    # 主界面
    st.title("📚 English Learning Assistant")
    st.markdown("---")
    
    # 导入并渲染主页面
    try:
        from ui.main_page import render_main_page
        render_main_page()
    except ImportError as e:
        st.error(f"导入主页面模块失败: {e}")
        st.info("请确保所有依赖已正确安装")
        st.code("pip install -r requirements.txt")

if __name__ == "__main__":
    main()
```

#### src/utils/config.py (配置管理)
```python
"""
配置管理模块
"""

import yaml
import streamlit as st
import os
from pathlib import Path
from typing import Any, Dict

class Config:
    """配置管理类"""
    
    def __init__(self, config_path: str = "config/app_config.yaml"):
        self.config_path = Path(config_path)
        self._config = self._load_config()
        self._load_secrets()
    
    def _load_config(self) -> Dict[str, Any]:
        """加载配置文件"""
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                return yaml.safe_load(f)
        except FileNotFoundError:
            st.error(f"配置文件未找到: {self.config_path}")
            return {}
        except yaml.YAMLError as e:
            st.error(f"配置文件解析错误: {e}")
            return {}
    
    def _load_secrets(self):
        """加载密钥配置 (项目特定命名)"""
        try:
            # 优先使用Streamlit secrets (项目特定名称)
            api_key = st.secrets.get("api", {}).get("ENGLISH_LEARNING_ZHIPU_API_KEY")
        except (KeyError, FileNotFoundError):
            # 回退到环境变量 (项目特定名称)
            api_key = os.getenv("ENGLISH_LEARNING_ZHIPU_API_KEY")
            if not api_key:
                # 兼容旧版本环境变量名
                api_key = os.getenv("ZHIPU_API_KEY")
        
        if api_key:
            self._config.setdefault("ai", {})["api_key"] = api_key
        else:
            st.warning("⚠️ 未找到AI API密钥 (ENGLISH_LEARNING_ZHIPU_API_KEY)，部分功能可能无法使用")
    
    def get(self, key_path: str, default=None) -> Any:
        """
        获取配置值
        
        Args:
            key_path: 配置路径，如 'ai.model'
            default: 默认值
            
        Returns:
            配置值
        """
        keys = key_path.split('.')
        value = self._config
        
        for key in keys:
            if isinstance(value, dict) and key in value:
                value = value[key]
            else:
                return default
                
        return value
    
    def get_prompts(self, prompt_name: str) -> str:
        """获取提示词"""
        prompts_file = Path("config/prompts.yaml")
        try:
            with open(prompts_file, 'r', encoding='utf-8') as f:
                prompts = yaml.safe_load(f)
                return prompts.get("prompts", {}).get(prompt_name, "")
        except FileNotFoundError:
            st.error(f"提示词文件未找到: {prompts_file}")
            return ""

# 全局配置实例
config = Config()
```

#### src/utils/logger.py (日志管理)
```python
"""
日志管理模块
"""

import logging
import streamlit as st
from pathlib import Path
from datetime import datetime

def setup_logger(name: str = "english_learning", log_level: str = "INFO"):
    """
    设置日志记录器
    
    Args:
        name: 日志记录器名称
        log_level: 日志级别
        
    Returns:
        配置好的日志记录器
    """
    logger = logging.getLogger(name)
    logger.setLevel(getattr(logging, log_level.upper()))
    
    # 避免重复添加处理器
    if logger.handlers:
        return logger
    
    # 创建日志目录
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)
    
    # 文件处理器
    log_file = log_dir / f"{name}_{datetime.now().strftime('%Y%m%d')}.log"
    file_handler = logging.FileHandler(log_file, encoding='utf-8')
    file_handler.setLevel(logging.DEBUG)
    
    # 控制台处理器
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    
    # 格式器
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    file_handler.setFormatter(formatter)
    console_handler.setFormatter(formatter)
    
    # 添加处理器
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)
    
    return logger

# 创建默认日志记录器
logger = setup_logger()

def log_streamlit(level: str, message: str, details: dict = None):
    """
    在Streamlit界面显示日志信息
    
    Args:
        level: 日志级别 (info, warning, error, success)
        message: 日志消息
        details: 详细信息
    """
    # 记录到日志文件
    getattr(logger, level.lower(), logger.info)(message)
    
    # 在Streamlit界面显示
    if level.lower() == 'error':
        st.error(message)
    elif level.lower() == 'warning':
        st.warning(message)
    elif level.lower() == 'success':
        st.success(message)
    else:
        st.info(message)
    
    # 显示详细信息
    if details and st.get_option("runner.fastReruns"):
        with st.expander("详细信息"):
            st.json(details)
```

## 开发工作流

### 1. 每日开发流程
```bash
# 1. 激活项目特定虚拟环境
source english-learning-env/bin/activate  # Linux/macOS
# 或
english-learning-env\Scripts\activate     # Windows

# 2. 设置项目特定环境变量
export ENGLISH_LEARNING_ZHIPU_API_KEY="your-api-key-here"
# Windows: set ENGLISH_LEARNING_ZHIPU_API_KEY=your-api-key-here

# 3. 拉取最新代码
git pull origin main

# 4. 安装/更新依赖 (AI增强版本)
pip install -r requirements.txt

# 5. 启动开发服务器
streamlit run streamlit_app.py

# 6. 开发完成后提交
git add .
git commit -m "描述: 具体修改内容"
git push origin main
```

### 2. 代码规范
```bash
# 安装代码格式化工具
pip install black flake8 mypy

# 格式化代码
black src/ --line-length 88

# 代码检查
flake8 src/ --max-line-length 88 --ignore E203,W503

# 类型检查
mypy src/ --ignore-missing-imports
```

### 3. 测试流程
```bash
# 运行测试
pytest tests/ -v

# 测试覆盖率
pytest tests/ --cov=src --cov-report=html
```

## 开发规范

### 1. 代码结构规范
```python
# 文件头部注释
"""
模块名称
简要描述模块功能
"""

# 导入顺序
import os  # 标准库
import sys

import streamlit as st  # 第三方库
import pandas as pd

from src.utils.config import config  # 本地模块
```

### 2. 函数规范
```python
def function_name(param1: str, param2: int = 0) -> str:
    """
    函数简要描述
    
    Args:
        param1: 参数1描述
        param2: 参数2描述，默认值0
        
    Returns:
        返回值描述
        
    Raises:
        ValueError: 异常情况描述
    """
    pass
```

### 3. 异常处理规范
```python
def safe_operation():
    """安全操作示例"""
    try:
        # 可能出错的操作
        result = risky_operation()
        return result
    except SpecificException as e:
        logger.error(f"具体错误: {e}")
        st.error("用户友好的错误消息")
        return None
    except Exception as e:
        logger.error(f"未预期错误: {e}")
        st.error("操作失败，请重试")
        return None
```

## 调试指南

### 1. 本地调试
```python
# 在代码中添加调试信息
if config.get("app.debug", False):
    st.write("🐛 调试信息:")
    st.json({
        "session_state": dict(st.session_state),
        "config": config._config
    })
```

### 2. 日志调试
```python
from src.utils.logger import logger

# 记录调试信息
logger.debug(f"处理文件: {filename}")
logger.info(f"OCR识别结果: {ocr_result}")
logger.warning(f"性能警告: 处理时间 {elapsed_time:.2f}s")
logger.error(f"处理失败: {error}")
```

### 3. 性能调试
```python
import time
import streamlit as st

@st.cache_data
def cached_operation(data):
    """使用缓存优化性能"""
    return expensive_operation(data)

def timed_operation(func):
    """计时装饰器"""
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        elapsed = time.time() - start_time
        logger.info(f"{func.__name__} 耗时: {elapsed:.2f}s")
        return result
    return wrapper
```

## 常见问题解决

### 1. 依赖安装问题
```bash
# 清理pip缓存
pip cache purge

# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 2. 权限问题 (Windows)
```bash
# 以管理员身份运行命令行
# 或者使用用户安装
pip install --user package_name
```

### 3. 路径问题
```python
# 使用相对路径和Path对象
from pathlib import Path

project_root = Path(__file__).parent
config_path = project_root / "config" / "app_config.yaml"
```

通过以上指南，您可以快速搭建起完整的开发环境，开始English Learning Assistant项目的开发工作。